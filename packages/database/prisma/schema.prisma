// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  schemas  = ["public", "private"]
}

enum UserRole {
  SUPER_ADMIN // Manages all orgnaizations (can also accept org registrations)
  ORG_ADMIN // Manages a single organization (can also invite employees to their org)
  EMPLOYEE

  @@schema("public")
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY

  @@schema("public")
}

enum OrganizationStatus {
  PENDING // Awaiting super admin approval
  ACTIVE // Approved and operational
  REJECTED // Denied by super admin
  SUSPENDED
  INACTIVE

  @@schema("public")
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  isConfirmed    Boolean  @default(false)
  name           String
  role           UserRole @default(EMPLOYEE)
  organizationId String? // null for SUPER_ADMIN users
  departmentId   String? // null for SUPER_ADMIN and ORG_ADMIN users
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  password              Password?
  sessions              Session[]
  magicLinks            MagicLink[]
  profile               UserProfile?
  organization          Organization?      @relation("OrganizationMembers", fields: [organizationId], references: [id], onDelete: SetNull)
  department            Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  createdOrganization   Organization?      @relation("OrganizationCreator")
  approvedOrganizations Organization[]     @relation("OrganizationApprover")
  contracts             Contract[]
  documents             Documents[]
  employments           Employment[]       @relation("employments")
  managedEmployees      Employment[]       @relation("EmployeeLineManager")
  attendances           Attendance[]
  assignedSchedules     UserWorkSchedule[] // Many-to-many
  auditLogs             AuditLog[]

  @@index([organizationId])
  @@index([departmentId])
  @@schema("public")
}

model UserProfile {
  id          String    @id @default(uuid())
  userId      String    @unique
  dateOfBirth DateTime?
  gender      Gender?
  bio         String?   @db.Text
  phoneNumber String?

  // Address fields
  street1    String?
  street2    String?
  city       String?
  state      String?
  postalCode String?
  country    String?

  // Ensurance 
  insuranceProvider String?

  // Tax Info
  personalTaxId String?

  // Marital Status
  maritalStatus MaritalStatus?

  // Social Insurance
  socialInsuranceNumber String?

  // Emergency contact
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  nationality       String?
  profilePictureUrl String?
  timezone          String?  @default("UTC") // IANA timezone identifier (e.g., "Asia/Bangkok")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model Password {
  id               String   @id @default(uuid())
  userId           String   @unique
  hashedPassword   String
  failedLoginCount Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("private")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("private")
}

model MagicLink {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique // securely generated random token, not a UUID
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@schema("private")
}

model Organization {
  id           String             @id @default(uuid())
  name         String
  status       OrganizationStatus @default(PENDING)
  description  String?            @db.Text
  website      String?
  createdById  String             @unique // User can only create one organization
  approvedById String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  approvedAt   DateTime? // When super admin approved

  createdBy     User           @relation("OrganizationCreator", fields: [createdById], references: [id])
  approvedBy    User?          @relation("OrganizationApprover", fields: [approvedById], references: [id])
  branches      Branch[]
  users         User[]         @relation("OrganizationMembers")
  documents     Documents[]
  workSchedules WorkSchedule[]
  auditLogs     AuditLog[]

  @@index([approvedById])
  @@index([status])
  @@schema("public")
}

model Branch {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  street1        String?
  street2        String?
  city           String?
  state          String?
  postalCode     String?
  country        String
  phoneNumber    String?
  email          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  departments  Department[]

  @@index([organizationId])
  @@schema("public")
}

model Department {
  id          String   @id @default(uuid())
  branchId    String
  name        String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  branch      Branch       @relation(fields: [branchId], references: [id], onDelete: Cascade)
  users       User[]
  employments Employment[]

  @@index([branchId])
  @@schema("public")
}

// Contract records for tracking employment contracts
model Contract {
  id             String       @id @default(uuid())
  userId         String
  contractNumber String       @unique
  contractName   String
  contractType   ContractType
  startDate      DateTime
  endDate        DateTime? // null for permanent contracts
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contractNumber])
  @@index([isActive])
  @@schema("public")
}

// Employment records for tracking job positions and employment timeline
model Employment {
  id             String         @id @default(uuid())
  userId         String
  employeeId     String // Employee ID (e.g., "UNI203")
  jobTitleId     String // e.g., "UI UX Designer"
  employmentType EmploymentType // Full-time, Part-time, Contract, Intern
  lineManagerId  String? // Reference to manager's User ID
  departmentId   String? // Can track department changes over time
  effectiveDate  DateTime // When this position started
  endDate        DateTime? // null for current position
  isActive       Boolean        @default(true) // Is this the current position?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  user        User        @relation("employments", fields: [userId], references: [id], onDelete: Cascade)
  lineManager User?       @relation("EmployeeLineManager", fields: [lineManagerId], references: [id], onDelete: SetNull)
  jobTitle    JobTitles   @relation(fields: [jobTitleId], references: [id], onDelete: SetNull)
  department  Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([employeeId])
  @@index([lineManagerId])
  @@index([departmentId])
  @@index([isActive])
  @@schema("public")
}

model JobTitles {
  id          String       @id @default(uuid())
  title       String       @unique
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  employments Employment[]

  @@schema("public")
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  PREFER_NOT_TO_SAY

  @@schema("public")
}

enum DocumentType {
  ID_CARD
  PASSPORT
  DRIVERS_LICENSE
  BIRTH_CERTIFICATE
  SOCIAL_SECURITY_CARD
  TAX_DOCUMENT
  EMPLOYMENT_CONTRACT
  RESUME
  DEGREE_CERTIFICATE
  TRAINING_CERTIFICATE
  MEDICAL_CERTIFICATE
  BANK_STATEMENT
  PROOF_OF_ADDRESS
  OTHER

  @@schema("public")
}

model Documents {
  id             String       @id @default(uuid())
  userId         String
  organizationId String
  documentType   DocumentType
  fileName       String // Original file name
  fileUrl        String // S3/storage URL
  fileSize       Int? // Size in bytes
  mimeType       String? // e.g., "application/pdf"
  uploadedAt     DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([documentType])
  @@schema("public")
}

model Attendance {
  id               String           @id @default(uuid())
  userId           String
  organizationId   String // Denormalized for faster org-scoped queries
  date             DateTime         @db.Date
  clockIn          DateTime?
  clockInLocation  String?
  clockInTimezone  String?
  clockOut         DateTime?
  clockOutLocation String?
  clockOutTimezone String?
  scheduledHours   Decimal          @db.Decimal(5, 2) // From WorkSchedule
  loggedHours      Decimal          @db.Decimal(5, 2) // Calculated
  paidHours        Decimal          @db.Decimal(5, 2) // After deductions
  deficitHours     Decimal          @db.Decimal(5, 2) // Difference
  overtimeHours    Decimal          @default(0) @db.Decimal(5, 2)
  status           AttendanceStatus @default(PENDING)
  notes            String?          @db.Text
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([organizationId])
  @@index([date])
  @@index([organizationId, date]) // Composite index for org + date queries
  @@schema("public")
}

model WorkSchedule {
  id                  String           @id @default(uuid())
  organizationId      String
  name                String // e.g., "Mon-Fri, Duration 40 hours/week"
  scheduleType        WorkScheduleType @default(DURATION_BASED)
  isDefault           Boolean          @default(false) // Default schedule for new employees
  standardHoursPerDay Decimal?         @db.Decimal(5, 2) // e.g., 8.00
  totalWeeklyHours    Decimal          @db.Decimal(5, 2) // e.g., 40.00
  effectiveFrom       DateTime
  effectiveTo         DateTime?
  isActive            Boolean          @default(true)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  dailySchedules WorkScheduleDay[]
  assignedUsers  UserWorkSchedule[] // Many-to-many with users

  @@unique([organizationId, name]) // Unique schedule names per organization
  @@index([organizationId])
  @@index([isDefault])
  @@index([isActive])
  @@schema("public")
}

// Daily breakdown of work schedule
model WorkScheduleDay {
  id           String   @id @default(uuid())
  scheduleId   String
  dayOfWeek    Int // 0-6 (Sunday-Saturday)
  hoursPerDay  Decimal  @db.Decimal(5, 2) // e.g., 8.00
  startTime    String? // e.g., "09:00"
  endTime      String? // e.g., "17:00"
  isWorkingDay Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  schedule WorkSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, dayOfWeek])
  @@index([scheduleId])
  @@schema("public")
}

// Join table: Many users can have many work schedules
model UserWorkSchedule {
  id         String   @id @default(uuid())
  userId     String
  scheduleId String
  assignedAt DateTime @default(now())
  assignedBy String? // Who assigned this schedule
  isActive   Boolean  @default(true) // Current schedule vs historical
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedule WorkSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([userId, scheduleId]) // User can have same schedule only once
  @@index([userId])
  @@index([scheduleId])
  @@index([isActive])
  @@schema("public")
}

enum WorkScheduleType {
  DURATION_BASED // Track by total hours
  TIME_BASED // Track by clock in/out times
  FLEXIBLE // No fixed schedule

  @@schema("public")
}

enum AttendanceStatus {
  PENDING // Waiting for clock out
  COMPLETED // Clocked out
  APPROVED // Verified by manager
  REJECTED // Invalid entry
  ABSENT // No clock in

  @@schema("public")
}

enum ContractType {
  FULLTIME_PERMANENT
  FULLTIME_FIXED_TERM
  PARTTIME_PERMANENT
  PARTTIME_FIXED_TERM
  CONTRACTOR
  FREELANCE
  INTERN

  @@schema("public")
}

enum EmploymentType {
  FULLTIME
  PARTTIME
  CONTRACT
  INTERN
  FREELANCE

  @@schema("public")
}

enum AuditAction {
  // User actions
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_INVITED
  USER_ROLE_CHANGED

  // Organization actions
  ORGANIZATION_CREATED
  ORGANIZATION_APPROVED
  ORGANIZATION_REJECTED
  ORGANIZATION_SUSPENDED
  ORGANIZATION_UPDATED

  // Department/Branch actions
  DEPARTMENT_CREATED
  DEPARTMENT_UPDATED
  DEPARTMENT_DELETED
  BRANCH_CREATED
  BRANCH_UPDATED
  BRANCH_DELETED

  // Employment actions
  EMPLOYEE_HIRED
  EMPLOYEE_PROMOTED
  EMPLOYEE_TRANSFERRED
  EMPLOYEE_TERMINATED
  CONTRACT_CREATED
  CONTRACT_UPDATED
  CONTRACT_ENDED

  // Attendance actions
  ATTENDANCE_CLOCKED_IN
  ATTENDANCE_CLOCKED_OUT
  ATTENDANCE_APPROVED
  ATTENDANCE_REJECTED
  ATTENDANCE_UPDATED

  // Work schedule actions
  SCHEDULE_CREATED
  SCHEDULE_UPDATED
  SCHEDULE_DELETED

  // Document actions
  DOCUMENT_UPLOADED
  DOCUMENT_DELETED
  DOCUMENT_ACCESSED

  // Time off actions (for future use)
  TIME_OFF_REQUESTED
  TIME_OFF_APPROVED
  TIME_OFF_REJECTED
  TIME_OFF_CANCELLED

  // General
  SETTINGS_UPDATED
  OTHER

  @@schema("public")
}

// Audit log for tracking all organizational activities
model AuditLog {
  id             String      @id @default(uuid())
  organizationId String? // null for system-wide actions (e.g., org approval)
  userId         String // Who performed the action
  action         AuditAction
  entityType     String // e.g., "User", "Department", "Attendance"
  entityId       String? // ID of the affected entity
  metadata       Json? // Additional context (old values, new values, etc.)
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime    @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@schema("public")
}
